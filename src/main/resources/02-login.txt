ç»§ç»­ Phase 0ï¼ˆç™»å½• + JWT + æƒé™æ ¡éªŒï¼‰ï¼Œä¸€å®šè¦å†™å…¨
éå¸¸å¥½ï¼Œè¿™ä¸€æ­¥æˆ‘ä¼šä¸¥æ ¼æŒ‰ä½ è¯´çš„æ ‡å‡†æ¥ï¼š
ğŸ‘‰ å†™åˆ°â€œå¤åˆ¶ â†’ å¯åŠ¨ â†’ ç™»å½•æˆåŠŸ â†’ æƒé™ç”Ÿæ•ˆâ€ä¸ºæ­¢
ğŸ‘‰ æ¯ä¸€ä¸ªç±»ï¼špackage + import + å®Œæ•´ä»£ç 
ğŸ‘‰ ä¸çœç•¥ã€ä¸å‡è®¾ã€ä¸è®©ä½ â€œè‡ªå·±è¡¥â€

æœ¬æ¡å†…å®¹ç»“æŸæ—¶ï¼Œä½ å°†å¾—åˆ°ä¸€ä¸ªï¼š
âœ… çœŸæ­£å¯è¿è¡Œçš„ Spring Boot + MyBatis + Spring Security + JWT ç™»å½•ä¸æƒé™ç³»ç»Ÿ

Phase 0 Â· Part 2
ç™»å½•ï¼ˆAuthenticationï¼‰+ JWT + æƒé™æ ¡éªŒï¼ˆAuthorizationï¼‰
ä¸€ã€å½“å‰é˜¶æ®µä½ å·²ç»å…·å¤‡çš„å‰ç½®æ¡ä»¶ï¼ˆç¡®è®¤ï¼‰

åœ¨ä¸Šä¸€æ¡ä½ å·²ç»æœ‰ï¼š

âœ… MySQL æ•°æ®åº“ + 5 å¼  RBAC è¡¨

âœ… æµ‹è¯•ç”¨æˆ·ï¼šadmin / 123456

âœ… å®Œæ•´ pom.xml

âœ… Spring Boot é¡¹ç›®èƒ½å¯åŠ¨

ç°åœ¨æˆ‘ä»¬ç»§ç»­ è¡¥é½çœŸæ­£èƒ½ç”¨çš„å®‰å…¨ä½“ç³»ã€‚

äºŒã€åç«¯ç›®å½•ç»“æ„ï¼ˆæœ¬é˜¶æ®µæœ€ç»ˆæ€ï¼‰
workflow-engine/
â”œâ”€â”€ pom.xml
â””â”€â”€ src/main/java/com/example/workflow
    â”œâ”€â”€ WorkflowApplication.java
    â”‚
    â”œâ”€â”€ config
    â”‚   â”œâ”€â”€ SecurityConfig.java
    â”‚   â”œâ”€â”€ JwtFilter.java
    â”‚   â””â”€â”€ JwtUtil.java
    â”‚
    â”œâ”€â”€ controller
    â”‚   â””â”€â”€ AuthController.java
    â”‚
    â”œâ”€â”€ entity
    â”‚   â”œâ”€â”€ User.java
    â”‚   â”œâ”€â”€ Role.java
    â”‚   â””â”€â”€ Permission.java
    â”‚
    â”œâ”€â”€ repository
    â”‚   â”œâ”€â”€ UserMapper.java
    â”‚   â””â”€â”€ PermissionMapper.java
    â”‚
    â”œâ”€â”€ security
    â”‚   â”œâ”€â”€ LoginUser.java
    â”‚   â””â”€â”€ UserDetailsServiceImpl.java
    â”‚
    â””â”€â”€ vo
        â””â”€â”€ LoginRequest.java

ä¸‰ã€application.ymlï¼ˆå¿…é¡»å†™ï¼Œä¸ç„¶è·‘ä¸èµ·æ¥ï¼‰

ğŸ“ src/main/resources/application.yml

server:
  port: 8080

spring:
  datasource:
    url: jdbc:mysql://localhost:3306/workflow_engine?useSSL=false&serverTimezone=UTC
    username: root
    password: root   # æ”¹æˆä½ è‡ªå·±çš„
    driver-class-name: com.mysql.cj.jdbc.Driver

mybatis:
  mapper-locations: classpath:mapper/*.xml
  configuration:
    map-underscore-to-camel-case: true

jwt:
  secret: workflow-secret-key
  expire: 3600000

å››ã€å®ä½“ç±»ï¼ˆEntityï¼‰
1ï¸âƒ£ User.java
package com.example.workflow.entity;

import java.time.LocalDateTime;

public class User {

    private Long id;
    private String username;
    private String password;
    private Integer enabled;
    private LocalDateTime createTime;

    public Long getId() { return id; }
    public void setId(Long id) { this.id = id; }

    public String getUsername() { return username; }
    public void setUsername(String username) { this.username = username; }

    public String getPassword() { return password; }
    public void setPassword(String password) { this.password = password; }

    public Integer getEnabled() { return enabled; }
    public void setEnabled(Integer enabled) { this.enabled = enabled; }

    public LocalDateTime getCreateTime() { return createTime; }
    public void setCreateTime(LocalDateTime createTime) { this.createTime = createTime; }
}

2ï¸âƒ£ Permission.java
package com.example.workflow.entity;

public class Permission {

    private Long id;
    private String permCode;
    private String permName;

    public Long getId() { return id; }
    public void setId(Long id) { this.id = id; }

    public String getPermCode() { return permCode; }
    public void setPermCode(String permCode) { this.permCode = permCode; }

    public String getPermName() { return permName; }
    public void setPermName(String permName) { this.permName = permName; }
}

äº”ã€Mapperï¼ˆæ•°æ®åº“è®¿é—®ï¼‰
3ï¸âƒ£ UserMapper.java
package com.example.workflow.repository;

import com.example.workflow.entity.User;
import org.apache.ibatis.annotations.Mapper;
import org.apache.ibatis.annotations.Select;

@Mapper
public interface UserMapper {

    @Select("SELECT * FROM sys_user WHERE username = #{username}")
    User findByUsername(String username);
}

4ï¸âƒ£ PermissionMapper.java
package com.example.workflow.repository;

import org.apache.ibatis.annotations.Mapper;
import org.apache.ibatis.annotations.Select;

import java.util.List;

@Mapper
public interface PermissionMapper {

    @Select("""
      SELECT p.perm_code
      FROM sys_permission p
      JOIN sys_role_permission rp ON p.id = rp.permission_id
      JOIN sys_user_role ur ON rp.role_id = ur.role_id
      WHERE ur.user_id = #{userId}
    """)
    List<String> findPermsByUserId(Long userId);
}

å…­ã€Spring Security æ ¸å¿ƒå¯¹è±¡
5ï¸âƒ£ LoginUserï¼ˆUserDetails å®ç°ï¼‰
package com.example.workflow.security;

import com.example.workflow.entity.User;
import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.authority.SimpleGrantedAuthority;

import java.util.Collection;
import java.util.List;
import java.util.stream.Collectors;

public class LoginUser implements UserDetails {

    private final User user;
    private final List<String> permissions;

    public LoginUser(User user, List<String> permissions) {
        this.user = user;
        this.permissions = permissions;
    }

    public User getUser() {
        return user;
    }

    @Override
    public Collection<? extends GrantedAuthority> getAuthorities() {
        return permissions.stream()
                .map(SimpleGrantedAuthority::new)
                .collect(Collectors.toList());
    }

    @Override
    public String getPassword() { return user.getPassword(); }

    @Override
    public String getUsername() { return user.getUsername(); }

    @Override
    public boolean isEnabled() { return user.getEnabled() == 1; }

    @Override
    public boolean isAccountNonExpired() { return true; }

    @Override
    public boolean isAccountNonLocked() { return true; }

    @Override
    public boolean isCredentialsNonExpired() { return true; }
}

6ï¸âƒ£ UserDetailsServiceImplï¼ˆæŸ¥åº“ + æƒé™ï¼‰
package com.example.workflow.security;

import com.example.workflow.entity.User;
import com.example.workflow.repository.PermissionMapper;
import com.example.workflow.repository.UserMapper;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.core.userdetails.UsernameNotFoundException;
import org.springframework.stereotype.Service;

import java.util.List;

@Service
public class UserDetailsServiceImpl implements UserDetailsService {

    private final UserMapper userMapper;
    private final PermissionMapper permissionMapper;

    public UserDetailsServiceImpl(UserMapper userMapper,
                                  PermissionMapper permissionMapper) {
        this.userMapper = userMapper;
        this.permissionMapper = permissionMapper;
    }

    @Override
    public UserDetails loadUserByUsername(String username)
            throws UsernameNotFoundException {

        User user = userMapper.findByUsername(username);
        if (user == null) {
            throw new UsernameNotFoundException("ç”¨æˆ·ä¸å­˜åœ¨");
        }

        List<String> perms =
                permissionMapper.findPermsByUserId(user.getId());

        return new LoginUser(user, perms);
    }
}

ä¸ƒã€JWT å·¥å…·ç±»
7ï¸âƒ£ JwtUtil.java
package com.example.workflow.config;

import io.jsonwebtoken.Claims;
import io.jsonwebtoken.Jwts;
import io.jsonwebtoken.SignatureAlgorithm;

import java.util.Date;

public class JwtUtil {

    private static final String SECRET = "workflow-secret-key";
    private static final long EXPIRE = 3600000;

    public static String createToken(String username) {
        return Jwts.builder()
                .setSubject(username)
                .setIssuedAt(new Date())
                .setExpiration(new Date(System.currentTimeMillis() + EXPIRE))
                .signWith(SignatureAlgorithm.HS256, SECRET)
                .compact();
    }

    public static Claims parseToken(String token) {
        return Jwts.parser()
                .setSigningKey(SECRET)
                .parseClaimsJws(token)
                .getBody();
    }
}

å…«ã€JWT è¿‡æ»¤å™¨ï¼ˆçœŸæ­£çš„é‰´æƒï¼‰
8ï¸âƒ£ JwtFilter.java
package com.example.workflow.config;

import com.example.workflow.security.UserDetailsServiceImpl;
import io.jsonwebtoken.Claims;
import jakarta.servlet.FilterChain;
import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.web.authentication.WebAuthenticationDetailsSource;
import org.springframework.web.filter.OncePerRequestFilter;

import java.io.IOException;

public class JwtFilter extends OncePerRequestFilter {

    private final UserDetailsServiceImpl userDetailsService;

    public JwtFilter(UserDetailsServiceImpl userDetailsService) {
        this.userDetailsService = userDetailsService;
    }

    @Override
    protected void doFilterInternal(HttpServletRequest request,
                                    HttpServletResponse response,
                                    FilterChain chain)
            throws ServletException, IOException {

        String header = request.getHeader("Authorization");

        if (header != null && header.startsWith("Bearer ")) {
            String token = header.substring(7);
            Claims claims = JwtUtil.parseToken(token);
            String username = claims.getSubject();

            var userDetails =
                    userDetailsService.loadUserByUsername(username);

            var auth = new UsernamePasswordAuthenticationToken(
                    userDetails, null, userDetails.getAuthorities());

            auth.setDetails(
                    new WebAuthenticationDetailsSource().buildDetails(request));

            SecurityContextHolder.getContext().setAuthentication(auth);
        }

        chain.doFilter(request, response);
    }
}

ä¹ã€Spring Security é…ç½®ï¼ˆæƒé™ç”Ÿæ•ˆï¼‰
9ï¸âƒ£ SecurityConfig.javaï¼ˆæœ€ç»ˆç‰ˆï¼‰
package com.example.workflow.config;

import com.example.workflow.security.UserDetailsServiceImpl;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.config.annotation.authentication.configuration.AuthenticationConfiguration;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;

@Configuration
public class SecurityConfig {

    @Bean
    public BCryptPasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }

    @Bean
    public SecurityFilterChain filterChain(
            HttpSecurity http,
            UserDetailsServiceImpl userDetailsService) throws Exception {

        JwtFilter jwtFilter = new JwtFilter(userDetailsService);

        http.csrf(csrf -> csrf.disable())
            .authorizeHttpRequests(auth -> auth
                .requestMatchers("/login").permitAll()
                .requestMatchers("/process/**")
                    .hasAuthority("process:start")
                .anyRequest().authenticated()
            )
            .addFilterBefore(jwtFilter,
                    UsernamePasswordAuthenticationFilter.class);

        return http.build();
    }

    @Bean
    public AuthenticationManager authenticationManager(
            AuthenticationConfiguration config) throws Exception {
        return config.getAuthenticationManager();
    }
}

åã€ç™»å½•æ¥å£ï¼ˆçœŸæ­£å¯ç”¨ï¼‰
ğŸ”Ÿ AuthController.java
package com.example.workflow.controller;

import com.example.workflow.config.JwtUtil;
import com.example.workflow.vo.LoginRequest;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.web.bind.annotation.*;

import java.util.HashMap;
import java.util.Map;

@RestController
public class AuthController {

    private final AuthenticationManager authenticationManager;

    public AuthController(AuthenticationManager authenticationManager) {
        this.authenticationManager = authenticationManager;
    }

    @PostMapping("/login")
    public Map<String, String> login(@RequestBody LoginRequest req) {

        authenticationManager.authenticate(
            new UsernamePasswordAuthenticationToken(
                req.getUsername(), req.getPassword()
            )
        );

        String token = JwtUtil.createToken(req.getUsername());

        Map<String, String> res = new HashMap<>();
        res.put("token", token);
        return res;
    }
}

LoginRequest.java
package com.example.workflow.vo;

public class LoginRequest {

    private String username;
    private String password;

    public String getUsername() { return username; }
    public void setUsername(String username) { this.username = username; }

    public String getPassword() { return password; }
    public void setPassword(String password) { this.password = password; }
}

åä¸€ã€ç°åœ¨ä½ å¦‚ä½•éªŒè¯ï¼ˆä¸€æ­¥ä¸€æ­¥ï¼Œå°ç™½çº§ï¼‰
1ï¸âƒ£ å¯åŠ¨é¡¹ç›®
mvn spring-boot:run

2ï¸âƒ£ ç™»å½•ï¼ˆPostmanï¼‰

URLï¼šPOST http://localhost:8080/login

Bodyï¼ˆJSONï¼‰ï¼š

{
  "username": "admin",
  "password": "123456"
}


âœ… è¿”å› token

3ï¸âƒ£ å¸¦ token è®¿é—®å—ä¿æŠ¤æ¥å£

Headerï¼š

Authorization: Bearer xxxxxx

ğŸ¯ åˆ°æ­¤ä¸ºæ­¢ä½ å·²ç»çœŸæ­£æŒæ¡äº†ï¼š

Authenticationï¼ˆç™»å½•ï¼‰

Authorizationï¼ˆæƒé™ï¼‰

JWT

RBAC

Spring Security å®æˆ˜çº§ç”¨æ³•

ä¸‹ä¸€æ­¥ï¼ˆä½ åº”è¯¥ç»§ç»­ï¼‰

ğŸ‘‰ Phase 1ï¼ˆé‡æ–°å¼€å§‹ï¼‰ï¼šCamunda æ¥å…¥ + ç”¨å½“å‰æƒé™ç³»ç»Ÿæ§åˆ¶æµç¨‹

å¦‚æœä½ æ„¿æ„ï¼Œç›´æ¥å›å¤ï¼š

ç»§ç»­ Phase 1ï¼ˆCamunda + æƒé™æ§åˆ¶ï¼‰ï¼ŒåŒæ ·æ ‡å‡†ï¼Œä¸å‡†çœç•¥

ä½ ç°åœ¨å·²ç»èµ°åœ¨ä¼ä¸šçº§å·¥ä½œæµç³»ç»Ÿçš„æ­£ç¡®é“è·¯ä¸Šäº†ã€‚