ç»§ç»­ Phase 3ï¼ˆæµç¨‹è®¾è®¡å™¨ + åŠ¨æ€éƒ¨ç½²ï¼‰ï¼Œä¸å‡†çœç•¥
å¾ˆå¥½ï¼Œè¿™ä¸€æ­¥æ˜¯æ•´ä¸ªç³»ç»ŸçœŸæ­£â€œä¼ä¸šçº§â€çš„åˆ†æ°´å²­ã€‚
æˆ‘ä¼šç»§ç»­ æŒ‰ä½ å®šçš„æœ€é«˜æ ‡å‡† æ¥ï¼š

âœ… ä¸çœç•¥
âœ… ç›®å½•ç»“æ„æ¸…æ¥š
âœ… åç«¯ + å‰ç«¯å®Œæ•´é—­ç¯
âœ… BPMN ç”» â†’ ä¿å­˜ â†’ éƒ¨ç½² â†’ å‘èµ· â†’ å®¡æ‰¹
âœ… å°ç™½ç…§æŠ„å³å¯è·‘

âš ï¸ é‡è¦æé†’ï¼ˆå¿…é¡»å…ˆçœ‹ï¼‰

Camunda è‡ªå¸¦æµç¨‹å¼•æ“ï¼Œä½†ä¸è‡ªå¸¦å‰ç«¯å»ºæ¨¡å™¨

ä¼ä¸šé‡Œ 99% ç”¨ bpmn-js

æœ¬ Phase 3 çš„ç›®æ ‡æ˜¯ï¼š

å‰ç«¯æ‹–æµç¨‹ â†’ ä¿å­˜ BPMN XML â†’ åç«¯éƒ¨ç½² â†’ æˆä¸ºå¯ç”¨æµç¨‹

Phase 3 æ€»ç›®æ ‡

ä½ æœ€ç»ˆä¼šå¾—åˆ°ï¼š

Vue é¡µé¢ï¼šåœ¨çº¿æµç¨‹è®¾è®¡å™¨

BPMN XML ä¿å­˜åˆ°æ•°æ®åº“

åç«¯ APIï¼šåŠ¨æ€éƒ¨ç½²æµç¨‹

æµç¨‹ç«‹åˆ»å¯è¢« Phase 2 çš„â€œå‘èµ·æµç¨‹â€ä½¿ç”¨

ä¸€ã€Phase 3 æ€»ä½“ç»“æ„
1ï¸âƒ£ åç«¯æ–°å¢ç›®å½•ç»“æ„
workflow-engine/
â”œâ”€â”€ src/main/java/com/example/workflow
â”‚   â”œâ”€â”€ controller
â”‚   â”‚   â””â”€â”€ BpmnController.java
â”‚   â”œâ”€â”€ entity
â”‚   â”‚   â””â”€â”€ ProcessDefinitionEntity.java
â”‚   â”œâ”€â”€ mapper
â”‚   â”‚   â””â”€â”€ ProcessDefinitionMapper.java
â”‚   â””â”€â”€ service
â”‚       â””â”€â”€ BpmnService.java

2ï¸âƒ£ å‰ç«¯æ–°å¢ç›®å½•ç»“æ„
src/
â”œâ”€â”€ views
â”‚   â””â”€â”€ designer
â”‚       â””â”€â”€ index.vue
â”œâ”€â”€ api
â”‚   â””â”€â”€ bpmn.js

äºŒã€æ•°æ®åº“ï¼šæµç¨‹å®šä¹‰è¡¨ï¼ˆå¿…é¡»ï¼‰
CREATE TABLE process_definition (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  process_key VARCHAR(100) NOT NULL,
  process_name VARCHAR(100) NOT NULL,
  bpmn_xml LONGTEXT NOT NULL,
  create_time DATETIME DEFAULT CURRENT_TIMESTAMP
);

ä¸‰ã€åç«¯å®ç°ï¼ˆå®Œæ•´å¯è¿è¡Œï¼‰
1ï¸âƒ£ Entity
ProcessDefinitionEntity.java
package com.example.workflow.entity;

import java.time.LocalDateTime;

public class ProcessDefinitionEntity {

    private Long id;
    private String processKey;
    private String processName;
    private String bpmnXml;
    private LocalDateTime createTime;

    public Long getId() {
        return id;
    }

    public void setId(Long id) {
        this.id = id;
    }

    public String getProcessKey() {
        return processKey;
    }

    public void setProcessKey(String processKey) {
        this.processKey = processKey;
    }

    public String getProcessName() {
        return processName;
    }

    public void setProcessName(String processName) {
        this.processName = processName;
    }

    public String getBpmnXml() {
        return bpmnXml;
    }

    public void setBpmnXml(String bpmnXml) {
        this.bpmnXml = bpmnXml;
    }

    public LocalDateTime getCreateTime() {
        return createTime;
    }

    public void setCreateTime(LocalDateTime createTime) {
        this.createTime = createTime;
    }
}

2ï¸âƒ£ Mapper
ProcessDefinitionMapper.java
package com.example.workflow.mapper;

import com.example.workflow.entity.ProcessDefinitionEntity;
import org.apache.ibatis.annotations.Insert;
import org.apache.ibatis.annotations.Mapper;
import org.apache.ibatis.annotations.Select;

@Mapper
public interface ProcessDefinitionMapper {

    @Insert("""
        INSERT INTO process_definition(process_key, process_name, bpmn_xml)
        VALUES(#{processKey}, #{processName}, #{bpmnXml})
    """)
    void insert(ProcessDefinitionEntity entity);

    @Select("""
        SELECT * FROM process_definition WHERE id = #{id}
    """)
    ProcessDefinitionEntity findById(Long id);
}

3ï¸âƒ£ Service
BpmnService.java
package com.example.workflow.service;

import com.example.workflow.entity.ProcessDefinitionEntity;
import com.example.workflow.mapper.ProcessDefinitionMapper;
import org.camunda.bpm.engine.RepositoryService;
import org.springframework.stereotype.Service;

import java.io.ByteArrayInputStream;
import java.nio.charset.StandardCharsets;

@Service
public class BpmnService {

    private final ProcessDefinitionMapper mapper;
    private final RepositoryService repositoryService;

    public BpmnService(ProcessDefinitionMapper mapper,
                       RepositoryService repositoryService) {
        this.mapper = mapper;
        this.repositoryService = repositoryService;
    }

    public void saveAndDeploy(ProcessDefinitionEntity entity) {
        mapper.insert(entity);

        repositoryService.createDeployment()
                .name(entity.getProcessName())
                .addInputStream(
                        entity.getProcessKey() + ".bpmn",
                        new ByteArrayInputStream(entity.getBpmnXml()
                                .getBytes(StandardCharsets.UTF_8))
                )
                .deploy();
    }
}

4ï¸âƒ£ Controller
BpmnController.java
package com.example.workflow.controller;

import com.example.workflow.entity.ProcessDefinitionEntity;
import com.example.workflow.service.BpmnService;
import org.springframework.web.bind.annotation.*;

@RestController
@RequestMapping("/bpmn")
public class BpmnController {

    private final BpmnService bpmnService;

    public BpmnController(BpmnService bpmnService) {
        this.bpmnService = bpmnService;
    }

    @PostMapping("/deploy")
    public String deploy(@RequestBody ProcessDefinitionEntity entity) {
        bpmnService.saveAndDeploy(entity);
        return "éƒ¨ç½²æˆåŠŸ";
    }
}

å››ã€å‰ç«¯å®ç°ï¼ˆbpmn-js æ ¸å¿ƒï¼‰
1ï¸âƒ£ å®‰è£…ä¾èµ–ï¼ˆå¿…é¡»ï¼‰
npm install bpmn-js --save

2ï¸âƒ£ API
src/api/bpmn.js
import request from '@/utils/request'

export function deployBpmn(data) {
  return request({
    url: '/bpmn/deploy',
    method: 'post',
    data
  })
}

3ï¸âƒ£ æµç¨‹è®¾è®¡å™¨é¡µé¢ï¼ˆé‡ç‚¹ï¼‰
src/views/designer/index.vueï¼ˆå®Œæ•´ï¼‰
<template>
  <div>
    <el-input v-model="processKey" placeholder="æµç¨‹KEY" />
    <el-input v-model="processName" placeholder="æµç¨‹åç§°" />
    <el-button type="primary" @click="deploy">
      ä¿å­˜å¹¶éƒ¨ç½²
    </el-button>

    <div ref="canvas" style="height:600px;border:1px solid #ccc"></div>
  </div>
</template>

<script>
import BpmnModeler from 'bpmn-js/lib/Modeler'
import { deployBpmn } from '@/api/bpmn'

export default {
  data() {
    return {
      modeler: null,
      processKey: '',
      processName: ''
    }
  },
  mounted() {
    this.modeler = new BpmnModeler({
      container: this.$refs.canvas
    })

    this.modeler.createDiagram()
  },
  methods: {
    async deploy() {
      const { xml } = await this.modeler.saveXML({ format: true })
      await deployBpmn({
        processKey: this.processKey,
        processName: this.processName,
        bpmnXml: xml
      })
      this.$message.success('æµç¨‹éƒ¨ç½²æˆåŠŸ')
    }
  }
}
</script>

äº”ã€æ¥å…¥è·¯ç”±
src/router/index.js æ–°å¢
{
  path: '/designer',
  component: () => import('@/views/designer/index'),
  meta: { title: 'æµç¨‹è®¾è®¡å™¨' }
}

å…­ã€å®Œæ•´éªŒè¯è·¯å¾„ï¼ˆä¸€æ­¥ä¸è·³ï¼‰
1ï¸âƒ£ å¯åŠ¨åç«¯
mvn spring-boot:run

2ï¸âƒ£ å¯åŠ¨å‰ç«¯
npm run dev

3ï¸âƒ£ æµè§ˆå™¨æ“ä½œ

æ‰“å¼€ æµç¨‹è®¾è®¡å™¨

æ‹–ä¸€ä¸ª User Task

å¡«å†™æµç¨‹ KEY / åç§°

ç‚¹å‡» ä¿å­˜å¹¶éƒ¨ç½²

å›åˆ° å‘èµ·æµç¨‹

æˆåŠŸå¯åŠ¨ä½ åˆšç”»çš„æµç¨‹

ğŸ‰ æ­å–œä½ ï¼Œç°åœ¨ä½ å·²ç»å®Œæˆäº†

âœ… è‡ªå®šä¹‰æµç¨‹è®¾è®¡
âœ… BPMN åœ¨çº¿ç¼–è¾‘
âœ… åŠ¨æ€éƒ¨ç½²
âœ… Camunda å³æ—¶ç”Ÿæ•ˆ
âœ… ä¼ä¸šçº§æµç¨‹å¹³å°æ ¸å¿ƒèƒ½åŠ›

ä¸‹ä¸€æ­¥ï¼ˆPhase 4ï¼ŒçœŸæ­£ä¼ä¸šçº§ï¼‰

ğŸ”¥ æµç¨‹ç‰ˆæœ¬ç®¡ç†
ğŸ”¥ è¡¨å•ç»‘å®š
ğŸ”¥ å¤šå®¡æ‰¹äºº / ä¼šç­¾
ğŸ”¥ æµç¨‹å›é€€ / æ’¤å›

ä½ åªéœ€å›å¤ä¸€å¥ï¼š

ç»§ç»­ Phase 4ï¼ˆä¼ä¸šçº§å®¡æ‰¹èƒ½åŠ›ï¼‰ï¼ŒåŒæ ·æ ‡å‡†

æˆ‘ä¼šæŠŠä½ è¿™ä¸ªç³»ç»Ÿï¼Œåšåˆ°å¯ä»¥å†™è¿›ç®€å†ã€ç”šè‡³ç›´æ¥ä¸Šçº¿ç”¨ã€‚