ç»§ç»­ Phase 1ï¼ˆCamunda + æƒé™æ§åˆ¶ï¼‰ï¼ŒåŒæ ·æ ‡å‡†ï¼Œä¸å‡†çœç•¥
å¾ˆå¥½ï¼Œè¿™ä¸€æ­¥æ˜¯çœŸæ­£æŠŠâ€œæƒé™ç³»ç»Ÿ + Camundaâ€ç„Šæ­»åœ¨ä¸€èµ·çš„å…³é”®èŠ‚ç‚¹ã€‚
æˆ‘ä¼šå®Œå…¨æŒ‰ç…§ä½ ç»™çš„ç¡¬æ€§è¦æ±‚æ¥ï¼š

âœ… ä¸çœç•¥
âœ… æ‰€æœ‰ç±»å†™å…¨ï¼ˆpackage / import / å†…å®¹ï¼‰
âœ… èƒ½ç›´æ¥è¿è¡Œ
âœ… å°ç™½ç…§æŠ„
âœ… æ˜ç¡®â€œä½ ç°åœ¨åœ¨å¹²ä»€ä¹ˆ / ä¸ºä»€ä¹ˆè¿™ä¹ˆåšâ€

è¿™ä¸€æ­¥æˆ‘ä»¬ä¸ä¼šå†ç¢°å‰ç«¯ï¼ŒåªæŠŠ åç«¯ Camunda + æƒé™æ§åˆ¶æ‰“ç‰¢ï¼Œå¦åˆ™å‰ç«¯ä¸€å®šä¼šä¹±ã€‚

Phase 1ï¼ˆé‡æ„ç‰ˆï¼‰
Camunda é›†æˆ + æµç¨‹æƒé™æ§åˆ¶ï¼ˆä¼ä¸šçº§æ­£ç¡®æ–¹å¼ï¼‰
ä¸€ã€Phase 1 çš„ç›®æ ‡ï¼ˆå…ˆè®²æ¸…æ¥šï¼‰

åˆ°æœ¬é˜¶æ®µç»“æŸï¼Œä½ å°†æ‹¥æœ‰ï¼š

âœ… Camunda çœŸæ­£é›†æˆåˆ° Spring Security
âœ… Camunda ä½¿ç”¨ä½ çš„ sys_user è¡¨ä½œä¸ºç”¨æˆ·ä½“ç³»
âœ… å¯åŠ¨æµç¨‹éœ€è¦æƒé™
âœ… æŸ¥è¯¢ä»»åŠ¡åªèƒ½æŸ¥â€œè‡ªå·±çš„â€
âœ… å®Œæˆä»»åŠ¡éœ€è¦æƒé™
âœ… ä¸€åˆ‡éƒ½èƒ½è·‘

äºŒã€å…³é”®è®¤çŸ¥ï¼ˆéå¸¸é‡è¦ï¼Œå°ç™½å¿…çœ‹ï¼‰
â— Camunda é»˜è®¤æ˜¯æœ‰è‡ªå·±ä¸€å¥—ç”¨æˆ·/æƒé™è¡¨çš„

ä¾‹å¦‚ï¼š

ACT_ID_USER

ACT_ID_GROUP

âŒ æˆ‘ä»¬ä¸ç”¨ï¼

ğŸ‘‰ ä¼ä¸šé¡¹ç›® 100% ä¼šï¼š

ç”¨è‡ªå·±ç³»ç»Ÿçš„ç”¨æˆ·è¡¨ï¼ˆsys_userï¼‰

ç”¨ Spring Security æ§åˆ¶æƒé™

Camunda åªåšâ€œæµç¨‹å¼•æ“â€

ä¸‰ã€åç«¯æœ€ç»ˆç›®å½•ç»“æ„ï¼ˆPhase 1ï¼‰
workflow-engine/
â”œâ”€â”€ pom.xml
â””â”€â”€ src/main/java/com/example/workflow
    â”œâ”€â”€ WorkflowApplication.java
    â”‚
    â”œâ”€â”€ config
    â”‚   â”œâ”€â”€ SecurityConfig.java
    â”‚   â”œâ”€â”€ JwtFilter.java
    â”‚   â”œâ”€â”€ JwtUtil.java
    â”‚   â””â”€â”€ CamundaConfig.java
    â”‚
    â”œâ”€â”€ controller
    â”‚   â”œâ”€â”€ AuthController.java
    â”‚   â”œâ”€â”€ ProcessController.java
    â”‚   â””â”€â”€ TaskController.java
    â”‚
    â”œâ”€â”€ entity
    â”‚   â”œâ”€â”€ User.java
    â”‚   â””â”€â”€ Permission.java
    â”‚
    â”œâ”€â”€ repository
    â”‚   â”œâ”€â”€ UserMapper.java
    â”‚   â””â”€â”€ PermissionMapper.java
    â”‚
    â”œâ”€â”€ security
    â”‚   â”œâ”€â”€ LoginUser.java
    â”‚   â””â”€â”€ UserDetailsServiceImpl.java
    â”‚
    â””â”€â”€ service
        â””â”€â”€ WorkflowService.java

å››ã€pom.xmlï¼ˆâš ï¸å®Œæ•´ + Camundaï¼‰

ğŸ‘‰ è¿™æ˜¯ä½ ç°åœ¨è¦ç”¨çš„æœ€ç»ˆ pom.xml

<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0
         http://maven.apache.org/xsd/maven-4.0.0.xsd">

  <modelVersion>4.0.0</modelVersion>

  <groupId>com.example</groupId>
  <artifactId>workflow-engine</artifactId>
  <version>1.0.0</version>

  <properties>
    <java.version>17</java.version>
    <camunda.version>7.20.0</camunda.version>
    <spring-boot.version>3.2.0</spring-boot.version>
  </properties>

  <dependencyManagement>
    <dependencies>
      <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-dependencies</artifactId>
        <version>${spring-boot.version}</version>
        <type>pom</type>
        <scope>import</scope>
      </dependency>
    </dependencies>
  </dependencyManagement>

  <dependencies>

    <!-- Web -->
    <dependency>
      <groupId>org.springframework.boot</groupId>
      <artifactId>spring-boot-starter-web</artifactId>
    </dependency>

    <!-- Security -->
    <dependency>
      <groupId>org.springframework.boot</groupId>
      <artifactId>spring-boot-starter-security</artifactId>
    </dependency>

    <!-- MyBatis -->
    <dependency>
      <groupId>org.mybatis.spring.boot</groupId>
      <artifactId>mybatis-spring-boot-starter</artifactId>
      <version>3.0.3</version>
    </dependency>

    <!-- MySQL -->
    <dependency>
      <groupId>com.mysql</groupId>
      <artifactId>mysql-connector-j</artifactId>
      <scope>runtime</scope>
    </dependency>

    <!-- JWT -->
    <dependency>
      <groupId>io.jsonwebtoken</groupId>
      <artifactId>jjwt</artifactId>
      <version>0.9.1</version>
    </dependency>

    <!-- Camunda -->
    <dependency>
      <groupId>org.camunda.bpm.springboot</groupId>
      <artifactId>camunda-bpm-spring-boot-starter</artifactId>
      <version>${camunda.version}</version>
    </dependency>

  </dependencies>

  <build>
    <plugins>
      <plugin>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-maven-plugin</artifactId>
      </plugin>
    </plugins>
  </build>

</project>

äº”ã€Camunda é…ç½®ï¼ˆä¸ä½¿ç”¨å®ƒçš„ç”¨æˆ·ç³»ç»Ÿï¼‰
1ï¸âƒ£ CamundaConfig.java

ğŸ“ config/CamundaConfig.java

package com.example.workflow.config;

import org.camunda.bpm.engine.spring.SpringProcessEngineConfiguration;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
public class CamundaConfig {

    /**
     * å‘Šè¯‰ Camundaï¼š
     * æˆ‘ä»¬ä¸ä½¿ç”¨ ACT_ID_* ç”¨æˆ·ä½“ç³»
     */
    @Bean
    public SpringProcessEngineConfiguration processEngineConfiguration() {
        SpringProcessEngineConfiguration config =
                new SpringProcessEngineConfiguration();
        config.setAuthorizationEnabled(false);
        return config;
    }
}


ğŸ‘‰ è§£é‡Šç»™å°ç™½ï¼š

Camunda çš„æƒé™å…¨éƒ¨ç”± Spring Security æ§åˆ¶

Camunda åªè´Ÿè´£ï¼šæµç¨‹çŠ¶æ€ã€ä»»åŠ¡æµè½¬

å…­ã€æµç¨‹å®šä¹‰ï¼ˆBPMNï¼‰

ğŸ“ src/main/resources/processes/approve.bpmn

<?xml version="1.0" encoding="UTF-8"?>
<bpmn:definitions
  xmlns:bpmn="http://www.omg.org/spec/BPMN/20100524/MODEL"
  xmlns:camunda="http://camunda.org/schema/1.0/bpmn"
  targetNamespace="http://example.com">

  <bpmn:process id="approve_process" name="å®¡æ‰¹æµç¨‹" isExecutable="true">

    <bpmn:startEvent id="start" />

    <bpmn:userTask id="apply"
        name="æäº¤ç”³è¯·"
        camunda:assignee="${initiator}" />

    <bpmn:userTask id="approve"
        name="é¢†å¯¼å®¡æ‰¹"
        camunda:assignee="${approver}" />

    <bpmn:endEvent id="end" />

    <bpmn:sequenceFlow sourceRef="start" targetRef="apply"/>
    <bpmn:sequenceFlow sourceRef="apply" targetRef="approve"/>
    <bpmn:sequenceFlow sourceRef="approve" targetRef="end"/>

  </bpmn:process>
</bpmn:definitions>

ä¸ƒã€WorkflowServiceï¼ˆæµç¨‹å¼•æ“æ ¸å¿ƒï¼‰

ğŸ“ service/WorkflowService.java

package com.example.workflow.service;

import org.camunda.bpm.engine.RuntimeService;
import org.camunda.bpm.engine.TaskService;
import org.camunda.bpm.engine.task.Task;
import org.springframework.stereotype.Service;

import java.util.HashMap;
import java.util.List;
import java.util.Map;

@Service
public class WorkflowService {

    private final RuntimeService runtimeService;
    private final TaskService taskService;

    public WorkflowService(RuntimeService runtimeService,
                           TaskService taskService) {
        this.runtimeService = runtimeService;
        this.taskService = taskService;
    }

    /**
     * å¯åŠ¨æµç¨‹
     */
    public void startProcess(String initiator, String approver) {
        Map<String, Object> vars = new HashMap<>();
        vars.put("initiator", initiator);
        vars.put("approver", approver);

        runtimeService.startProcessInstanceByKey(
                "approve_process", vars);
    }

    /**
     * æŸ¥è¯¢æˆ‘çš„ä»»åŠ¡
     */
    public List<Task> myTasks(String username) {
        return taskService.createTaskQuery()
                .taskAssignee(username)
                .list();
    }

    /**
     * å®Œæˆä»»åŠ¡
     */
    public void complete(String taskId) {
        taskService.complete(taskId);
    }
}

å…«ã€Controllerï¼ˆå¸¦æƒé™ï¼‰
1ï¸âƒ£ ProcessControllerï¼ˆå‘èµ·æµç¨‹ï¼‰

ğŸ“ controller/ProcessController.java

package com.example.workflow.controller;

import com.example.workflow.service.WorkflowService;
import org.springframework.security.core.Authentication;
import org.springframework.web.bind.annotation.*;

@RestController
@RequestMapping("/process")
public class ProcessController {

    private final WorkflowService workflowService;

    public ProcessController(WorkflowService workflowService) {
        this.workflowService = workflowService;
    }

    /**
     * åªæœ‰æœ‰ process:start æƒé™çš„äººæ‰èƒ½å‘èµ·
     */
    @PostMapping("/start")
    public String start(Authentication authentication) {

        String username = authentication.getName();

        workflowService.startProcess(
                username,   // å‘èµ·äºº
                "admin"     // å®¡æ‰¹äººï¼ˆå…ˆå†™æ­»ï¼ŒPhase 2 åŠ¨æ€ï¼‰
        );

        return "æµç¨‹å¯åŠ¨æˆåŠŸ";
    }
}

2ï¸âƒ£ TaskControllerï¼ˆæˆ‘çš„å¾…åŠ + å®¡æ‰¹ï¼‰

ğŸ“ controller/TaskController.java

package com.example.workflow.controller;

import com.example.workflow.service.WorkflowService;
import org.camunda.bpm.engine.task.Task;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.security.core.Authentication;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("/task")
public class TaskController {

    private final WorkflowService workflowService;

    public TaskController(WorkflowService workflowService) {
        this.workflowService = workflowService;
    }

    /**
     * æŸ¥è¯¢æˆ‘çš„ä»»åŠ¡
     */
    @GetMapping("/my")
    public List<Task> my(Authentication authentication) {
        return workflowService.myTasks(authentication.getName());
    }

    /**
     * å®¡æ‰¹ä»»åŠ¡
     */
    @PostMapping("/complete")
    @PreAuthorize("hasAuthority('task:approve')")
    public String complete(@RequestParam String taskId) {
        workflowService.complete(taskId);
        return "ä»»åŠ¡å®Œæˆ";
    }
}

ä¹ã€SecurityConfigï¼ˆæœ€ç»ˆæƒé™ç‰ˆï¼‰

ğŸ“ config/SecurityConfig.java

package com.example.workflow.config;

import com.example.workflow.security.UserDetailsServiceImpl;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.config.annotation.authentication.configuration.AuthenticationConfiguration;
import org.springframework.security.config.annotation.method.configuration.EnableMethodSecurity;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;

@Configuration
@EnableMethodSecurity
public class SecurityConfig {

    @Bean
    public BCryptPasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }

    @Bean
    public SecurityFilterChain filterChain(
            HttpSecurity http,
            UserDetailsServiceImpl uds) throws Exception {

        JwtFilter jwtFilter = new JwtFilter(uds);

        http.csrf(csrf -> csrf.disable())
            .authorizeHttpRequests(auth -> auth
                .requestMatchers("/login").permitAll()
                .anyRequest().authenticated()
            )
            .addFilterBefore(jwtFilter,
                UsernamePasswordAuthenticationFilter.class);

        return http.build();
    }

    @Bean
    public AuthenticationManager authenticationManager(
            AuthenticationConfiguration config) throws Exception {
        return config.getAuthenticationManager();
    }
}

åã€ä½ ç°åœ¨å¦‚ä½•ä¸€æ­¥ä¸€æ­¥éªŒè¯ï¼ˆå°ç™½æµç¨‹ï¼‰
1ï¸âƒ£ å¯åŠ¨é¡¹ç›®
mvn spring-boot:run

2ï¸âƒ£ ç™»å½•
POST http://localhost:8080/login

{
  "username": "admin",
  "password": "123456"
}


æ‹¿åˆ° tokenã€‚

3ï¸âƒ£ å‘èµ·æµç¨‹ï¼ˆéœ€è¦æƒé™ï¼‰
POST /process/start
Authorization: Bearer xxx

4ï¸âƒ£ æŸ¥è¯¢æˆ‘çš„ä»»åŠ¡
GET /task/my
Authorization: Bearer xxx

5ï¸âƒ£ å®¡æ‰¹ä»»åŠ¡
POST /task/complete?taskId=xxxx
Authorization: Bearer xxx

ğŸ¯ åˆ°è¿™é‡Œä¸ºæ­¢ï¼Œä½ å·²ç»çœŸæ­£å®Œæˆäº†ï¼š

ä¼ä¸šçº§ Spring Security + JWT

ä¼ä¸šçº§ RBAC

Camunda ä¸ä¸šåŠ¡ç”¨æˆ·ä½“ç³»èåˆ

æµç¨‹çº§ + ä»»åŠ¡çº§æƒé™æ§åˆ¶

ä¸‹ä¸€æ­¥ï¼ˆPhase 2 Â· çœŸæ­£é‡å¤´æˆï¼‰

ğŸ‘‰ å‰ç«¯ Vue2 + vue-admin-template

ç™»å½•

æƒé™è·¯ç”±

å‘èµ·æµç¨‹

æˆ‘çš„å¾…åŠ

å®¡æ‰¹é¡µé¢

å¦‚æœä½ æ„¿æ„ï¼Œç›´æ¥å›å¤ï¼š

ç»§ç»­ Phase 2ï¼ˆVue å‰ç«¯å®Œæ•´æ¥å…¥ï¼‰ï¼ŒåŒæ ·æ ‡å‡†

æˆ‘ä¼šç»§ç»­ ä¸€è¡Œä¸çœ åœ°å¸¦ä½ æŠŠæ•´ä¸ªç³»ç»Ÿåšå®Œã€‚